// ========================================
// ãƒœã‚¤ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ—ãƒª - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼
// ========================================
// ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯Node.js + Expressã§æ›¸ã‹ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ã§ã™
// Flutterã‚¢ãƒ—ãƒªã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã£ãŸã‚Šã€
// ä¿å­˜ã•ã‚Œã¦ã„ã‚‹éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ãƒ»å†ç”Ÿã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™

// ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ï¼ˆæœ€åˆã«å®Ÿè¡Œï¼‰
require('dotenv').config();

// å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆNode.jsã®æ©Ÿèƒ½ï¼‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const express = require('express');          // Webã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
const cors = require('cors');                // CORSå¯¾å¿œ
const multer = require('multer');            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å‡¦ç†ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
const path = require('path');                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
const fs = require('fs');                    // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚’è¡Œã†ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
const connectDB = require('./config/database'); // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š

const app = express();                       // Expressã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
const PORT = process.env.PORT || 3000;       // ã‚µãƒ¼ãƒãƒ¼ãŒå¾…æ©Ÿã™ã‚‹ãƒãƒ¼ãƒˆç•ªå·

// ========================================
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
// ========================================
connectDB();

// ========================================
// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š
// ========================================
// JSONå½¢å¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ãƒ‘ãƒ¼ã‚¹
app.use(express.json());
// URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
app.use(express.urlencoded({ extended: true }));
// CORSè¨­å®šï¼ˆã™ã¹ã¦ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¨±å¯ï¼‰
app.use(cors());

// ========================================
// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
// ========================================
// èªè¨¼é–¢é€£ã®ãƒ«ãƒ¼ãƒˆ
app.use('/auth', require('./routes/auth'));
// ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã®ãƒ«ãƒ¼ãƒˆ
app.use('/users', require('./routes/user'));
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢é€£ã®ãƒ«ãƒ¼ãƒˆ
app.use('/messages', require('./routes/message'));

// ========================================
// ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜è¨­å®š
// ========================================
// éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
const uploadDir = path.join(__dirname, 'uploads');

// uploadsãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã™ã‚‹
// __dirname ã¯ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ã‚’è¡¨ã—ã¾ã™
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir);
}

// Multerã®è¨­å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã©ã®ã‚ˆã†ã«ä¿å­˜ã™ã‚‹ã‹ï¼‰
const storage = multer.diskStorage({
  // destination: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã©ã“ã«ä¿å­˜ã™ã‚‹ã‹
  destination: (req, file, cb) => {
    cb(null, uploadDir);  // uploadsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
  },
  
  // filename: ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã©ã†ã™ã‚‹ã‹
  filename: (req, file, cb) => {
    // ä¾‹ï¼š1703234567890-voice.m4a
    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— + ãƒ•ã‚¡ã‚¤ãƒ«åã§ã€é‡è¤‡ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½œæˆ
    cb(null, Date.now() + '-' + file.originalname);
  }
});
const upload = multer({ storage });

// ========================================
// API 1: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰API
// ========================================
// Flutterã‚¢ãƒ—ãƒªã‹ã‚‰éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã£ã¦ä¿å­˜ã™ã‚‹
// POST http://localhost:3000/upload
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼šmultipart/form-data ã§ voice ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚ã‚‹
app.post('/upload', upload.single('voice'), (req, res) => {
  if (!req.file) {
    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé€ã‚‰ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    return res.status(400).json({ error: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“' });
  }
  // æˆåŠŸã—ãŸå ´åˆã¯ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’Flutterã‚¢ãƒ—ãƒªã«è¿”ã™
  res.json({ filename: req.file.filename });
});

// ========================================
// API 2: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—API
// ========================================
// ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…¨ã¦ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
// GET http://localhost:3000/voices
// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼š{ "files": ["1703234567890-voice1.m4a", "1703234890-voice2.m4a"] }
app.get('/voices', (req, res) => {
  // uploadsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®ãƒªã‚¹ãƒˆã‚’è¿”ã™
  if (!fs.existsSync(uploadDir)) {
    return res.json({ files: [] });
  }
  
  // uploadsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
  const files = fs.readdirSync(uploadDir).filter(file => {
    // æ­£è¦è¡¨ç¾ã§éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’æŠ½å‡º
    // m4a, mp3, wav, aac, ogg ãªã©ã®æ‹¡å¼µå­ã‚’æŒã¤ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    return /\.(m4a|mp3|wav|aac|ogg)$/i.test(file);
  });
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’JSONã§è¿”ã™
  res.json({ files });
});

// ========================================
// API 3: éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰API
// ========================================
// ç‰¹å®šã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦å†ç”Ÿã™ã‚‹
// GET http://localhost:3000/voice/:filename
// ä¾‹ï¼šGET http://localhost:3000/voice/1703234567890-voice.m4a
app.get('/voice/:filename', (req, res) => {
  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ä½œæˆ
  const filePath = path.join(uploadDir, req.params.filename);
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  if (!fs.existsSync(filePath)) {
    return res.status(404).json({ error: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }
  
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆFlutterã‚¢ãƒ—ãƒªï¼‰ã«é€ä¿¡
  // sendFileã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«é–‹ã„ã¦é€ä¿¡ã—ã¦ãã‚Œã¾ã™
  res.sendFile(filePath);
});

// ========================================
// ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
// ========================================
app.get('/health', (req, res) => {
  res.status(200).json({
    success: true,
    message: 'ã‚µãƒ¼ãƒãƒ¼ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™',
    timestamp: new Date().toISOString(),
  });
});

// ========================================
// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
// ========================================
// æŒ‡å®šã—ãŸPORTã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
// ãƒ†ã‚¹ãƒˆæ™‚ã¯ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ãªã„
if (process.env.NODE_ENV !== 'test') {
  app.listen(PORT, () => {
    console.log('========================================');
    console.log(`ğŸš€ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•: http://localhost:${PORT}`);
    console.log(`ğŸ“ ç’°å¢ƒ: ${process.env.NODE_ENV || 'development'}`);
    console.log('========================================');
  });
}

// ========================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚¯ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢ï¼‰
// ========================================
process.on('uncaughtException', (err) => {
  console.error('ã€è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã€‘uncaughtException:', err);
  // ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã•ã›ãªã„ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚’ç¶™ç¶šç¨¼åƒï¼‰
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('ã€è­¦å‘Šã€‘unhandledRejection:', reason, 'at:', promise);
  // ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã•ã›ãªã„ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚’ç¶™ç¶šç¨¼åƒï¼‰
});

// ãƒ†ã‚¹ãƒˆç”¨ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
module.exports = app;
