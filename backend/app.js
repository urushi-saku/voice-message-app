// ========================================
// ãƒœã‚¤ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ—ãƒª - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼
// ========================================
// ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯Node.js + Expressã§æ›¸ã‹ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ã§ã™
// Flutterã‚¢ãƒ—ãƒªã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã£ãŸã‚Šã€
// ä¿å­˜ã•ã‚Œã¦ã„ã‚‹éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ãƒ»å†ç”Ÿã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™

// ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ï¼ˆæœ€åˆã«å®Ÿè¡Œï¼‰
require('dotenv').config();

// å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆNode.jsã®æ©Ÿèƒ½ï¼‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const express = require('express');          // Webã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
const cors = require('cors');                // CORSå¯¾å¿œ
const path = require('path');                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
const fs = require('fs');                    // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚’è¡Œã†ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
const connectDB = require('./config/database'); // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š

const app = express();                       // Expressã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
const PORT = process.env.PORT || 3000;       // ã‚µãƒ¼ãƒãƒ¼ãŒå¾…æ©Ÿã™ã‚‹ãƒãƒ¼ãƒˆç•ªå·

// ========================================
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
// ========================================
connectDB();

// ========================================
// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š
// ========================================
// JSONå½¢å¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ãƒ‘ãƒ¼ã‚¹
app.use(express.json());
// URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
app.use(express.urlencoded({ extended: true }));
// CORSè¨­å®šï¼ˆã™ã¹ã¦ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¨±å¯ï¼‰
app.use(cors());

// ========================================
// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
// ========================================
// èªè¨¼é–¢é€£ã®ãƒ«ãƒ¼ãƒˆ
app.use('/auth', require('./routes/auth'));
// ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã®ãƒ«ãƒ¼ãƒˆ
app.use('/users', require('./routes/user'));
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢é€£ã®ãƒ«ãƒ¼ãƒˆ
app.use('/messages', require('./routes/message'));
// é€šçŸ¥é–¢é€£ã®ãƒ«ãƒ¼ãƒˆ
app.use('/notifications', require('./routes/notification'));
// ã‚°ãƒ«ãƒ¼ãƒ—é–¢é€£ã®ãƒ«ãƒ¼ãƒˆ
app.use('/groups', require('./routes/group'));

// ========================================
// uploadsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºä¿ï¼ˆmessages APIãŒä½¿ç”¨ï¼‰
// ========================================
const uploadDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir);
}

const groupUploadDir = path.join(__dirname, 'uploads', 'groups');
if (!fs.existsSync(groupUploadDir)) {
  fs.mkdirSync(groupUploadDir, { recursive: true });
}

// ========================================
// ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
// ========================================
app.get('/health', (req, res) => {
  res.status(200).json({
    success: true,
    message: 'ã‚µãƒ¼ãƒãƒ¼ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™',
    timestamp: new Date().toISOString(),
  });
});

// ========================================
// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
// ========================================
// æŒ‡å®šã—ãŸPORTã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
// ãƒ†ã‚¹ãƒˆæ™‚ã¯ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ãªã„
if (process.env.NODE_ENV !== 'test') {
  app.listen(PORT, () => {
    console.log('========================================');
    console.log(`ğŸš€ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•: http://localhost:${PORT}`);
    console.log(`ğŸ“ ç’°å¢ƒ: ${process.env.NODE_ENV || 'development'}`);
    console.log('========================================');
  });
}

// ========================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚¯ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢ï¼‰
// ========================================
process.on('uncaughtException', (err) => {
  console.error('ã€è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã€‘uncaughtException:', err);
  // ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã•ã›ãªã„ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚’ç¶™ç¶šç¨¼åƒï¼‰
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('ã€è­¦å‘Šã€‘unhandledRejection:', reason, 'at:', promise);
  // ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†ã•ã›ãªã„ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚’ç¶™ç¶šç¨¼åƒï¼‰
});

// ãƒ†ã‚¹ãƒˆç”¨ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
module.exports = app;
